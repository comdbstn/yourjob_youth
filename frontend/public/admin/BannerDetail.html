<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배너관리</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .success-message, .error-alert {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
        }

        .error-alert {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* 이미지 미리보기 영역에 스크롤 추가 */
        .thumb--banner {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .thumb--banner img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* 스크롤바 스타일링 (선택사항) */
        .thumb--banner::-webkit-scrollbar {
            width: 8px;
        }

        .thumb--banner::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .thumb--banner::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .thumb--banner::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
<main class="main">
    <!-- lnb -->
    <aside class="lnb">

        <!-- 로고 -->
        <div class="lnb__logo">
            <a href="/" class="lnb__logo--link">
                <img src="assets/images/logo.png">
            </a>
        </div>
        <!-- //로고 -->

        <!-- 메뉴1 -->
        <ul class="lnb--menu">
            <li>
                <a href="Jobs.html" class="btn">채용정보</a>
            </li>
            <li>
                <a href="Resumes.html" class="btn">이력서정보</a>
            </li>
            <li>
                <a href="Application.html" class="btn">입사지원</a>
            </li>
            <li>
                <a href="JobOffers.html" class="btn">포지션제안</a>
            </li>
            <li>
                <a href="CompanyProfile.html" class="btn">기업정보</a>
            </li>
            <li>
                <a href="CommunityPost.html" class="btn">커뮤니티</a>
            </li>
            <li>
                <a href="Payments.html" class="btn">결제관리</a>
            </li>
            <li>
                <a href="Products.html" class="btn">상품관리</a>
            </li>
            <li>
                <a href="Banner.html" class="btn isActive">배너관리</a>
            </li>
            <li>
                <a href="SuccessfulResumes.html" class="btn">합격자소서</a>
            </li>
            <li>
                <a href="DataManagement.html" class="btn">데이터관리</a>
            </li>
        </ul>
        <!-- //메뉴1 -->

        <!-- 메뉴2 -->
        <ul class="lnb--menu">
            <li>
                <a href="Statistics.html" class="btn">통계</a>
            </li>
            <li>
                <a href="UserManagement.html" class="btn">회원관리</a>
            </li>
            <li><a href="CommentReports.html" class="btn">댓글신고</a></li>
            <li>
                <a href="Settings.html" class="btn">환경설정</a>
            </li>
        </ul>
        <!-- //메뉴2 -->
    </aside>
    <!-- //lnb -->

    <!-- contents -->
    <div class="contents">

        <!-- 상단 네비 영역 -->
        <div class="navigation">
            <div class="container">
                <button type="button" class="btn btn-danger btn-small" id="btnLogout">로그아웃</button>
            </div>
        </div>
        <!-- //상단 네비 영역 -->

        <!-- 페이지 타이틀 -->
        <div class="title-area">
            <div class="container">
                <h2 class="title--h2" id="pageTitle">배너 등록</h2>
            </div>
        </div>
        <!-- //페이지 타이틀 -->

        <!-- 컨텐츠 영역 -->
        <div class="content">
            <div class="container">

                <article class="article-area nosearch-area">
                    <form id="bannerForm">
                        <!-- 배너 ID를 저장할 히든 필드 (수정 시 사용) -->
                        <input type="hidden" id="bannerId" name="id">

                        <ul class="list option">
                            <li class="items">
                                <span class="title">그룹명</span>
                                <div class="select-box">
                                    <div class="control">
                                        <select class="select" id="groupName" name="groupName">
                                            <option value="메인A">메인A</option>
                                            <option value="메인B">메인B</option>
                                            <option value="서브A">서브A</option>
                                            <option value="서브B">서브B</option>
                                        </select>
                                    </div>
                                </div>
                            </li>
                            <li class="items">
                                <span class="title">배너제목</span>
                                <div class="control">
                                    <input type="text" id="title" name="title" value="">
                                </div>
                                <div class="error-message" id="title-error">배너 제목을 입력해주세요.</div>
                            </li>

                            <li class="items">
                                <span class="title">배너이미지</span>
                                <div>
                                    <div class="form__input--file_wrap">
                                        <input class="form__input--file" id="upload1" type="file" accept="image/*">
                                        <span class="form__span--file">선택된 파일이 없습니다.</span>
                                        <label class="form__label--file" for="upload1">파일선택</label>
                                    </div>
                                    <div class="error-message" id="file-error">이미지 파일을 선택해주세요.</div>

                                    <div class="thumb--banner">
                                        <img id="preview-image" src="">
                                    </div>
                                </div>
                            </li>

                            <li class="items">
                                <span class="title">링크 타겟</span>
                                <div class="control">
                                    <input type="text" id="linkTarget" name="linkTarget" value="" placeholder="https://www.google.com">
                                </div>
                                <div class="select-box">
                                    <div class="control">
                                        <select class="select" id="linkTargetType" name="linkTargetType">
                                            <option value="_blank">새창으로</option>
                                            <option value="_self">바로이동</option>
                                        </select>
                                    </div>
                                </div>
                            </li>

                            <li class="items">
                                <span class="title">시작시간</span>
                                <div class="control">
                                    <input type="text" id="startDate" name="startDate" value="YYYY-MM-DD HH:mm:ss">
                                </div>
                                <button type="button" class="btn btn-success" id="startDatePicker">데이트피커</button>
                                <div class="error-message" id="startDate-error">유효한 시작 시간을 입력해주세요.</div>
                            </li>

                            <li class="items">
                                <span class="title">마감시간</span>
                                <div class="control">
                                    <input type="text" id="endDate" name="endDate" value="YYYY-MM-DD HH:mm:ss">
                                </div>
                                <button type="button" class="btn btn-success" id="endDatePicker">데이트피커</button>
                                <div class="error-message" id="endDate-error">유효한 마감 시간을 입력해주세요.</div>
                            </li>

                            <li class="items">
                                <span class="title">활성화여부</span>
                                <div class="form-radio">
                                    <div class="control">
                                        <input type="radio" id="statusActive" name="status" value="active" checked="checked">
                                        <span class="text">활성화</span>
                                    </div>
                                    <div class="control">
                                        <input type="radio" id="statusInactive" name="status" value="inactive">
                                        <span class="text">비활성화</span>
                                    </div>
                                </div>
                            </li>
                        </ul>

                        <div class="success-message" id="success-message">
                            배너가 성공적으로 등록되었습니다.
                        </div>
                        <div class="error-alert" id="error-alert">
                            배너 등록 중 오류가 발생했습니다.
                        </div>

                        <div class="btn-area">
                            <button type="button" class="btn btn-success" id="saveButton">저장</button>
                            <a href="Banner.html" class="btn btn-primary">목록으로</a>
                        </div>
                    </form>
                </article>
            </div>
        </div>
        <!-- //컨텐츠 영역 -->
    </div>
    <!-- //contents -->
</main>

<script src="./env-config.js"></script>
<script>
    const API_BASE_URL = window.__CONFIG__.API_BASE_URL;
    let isEditing = false;

    document.addEventListener('DOMContentLoaded', function() {
        // URL에서 id 파라미터 확인 (수정 모드인지 확인)
        const urlParams = new URLSearchParams(window.location.search);
        const bannerId = urlParams.get('id');

        if (bannerId) {
            // 수정 모드
            isEditing = true;
            document.getElementById('pageTitle').textContent = '배너 수정';
            loadBannerData(bannerId);
        } else {
            // 등록 모드
            isEditing = false;
            document.getElementById('pageTitle').textContent = '배너 등록';
            setDefaultDates();
        }

        // 파일 선택 및 미리보기 처리
        const fileTarget = document.querySelector('.form__input--file_wrap input');
        const previewImage = document.getElementById('preview-image');

        if (fileTarget) {
            fileTarget.addEventListener('change', (event) => {
                const inputElement = event.target;
                if (!inputElement.files || inputElement.files.length === 0) return;

                const files = inputElement.files;
                const fileArr = [];

                for (let i = 0; i < files.length; i++) {
                    fileArr.push(files[i].name);
                }

                const fileList = fileArr.join(', ');
                const fileSpan = inputElement.parentElement?.querySelector('.form__span--file');
                if (fileSpan) {
                    fileSpan.textContent = fileList;
                }

                // 이미지 미리보기 처리
                const selectedFile = inputElement.files[0];
                if (selectedFile && selectedFile.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                    };
                    reader.readAsDataURL(selectedFile);
                }
            });
        }

        // 저장 버튼 이벤트 처리
        document.getElementById('saveButton').addEventListener('click', async function() {
            if (validateForm()) {
                await saveBanner();
            }
        });

        // 데이트피커 버튼 이벤트
        document.getElementById('startDatePicker').addEventListener('click', function() {
            const now = new Date();
            document.getElementById('startDate').value = formatDateForInput(now);
        });

        document.getElementById('endDatePicker').addEventListener('click', function() {
            const now = new Date();
            const nextWeek = new Date(now);
            nextWeek.setDate(now.getDate() + 7);
            document.getElementById('endDate').value = formatDateForInput(nextWeek);
        });
    });

    // 기본 날짜 설정 함수
    function setDefaultDates() {
        const now = new Date();
        const nextWeek = new Date(now);
        nextWeek.setDate(now.getDate() + 7);

        document.getElementById('startDate').value = formatDateForInput(now);
        document.getElementById('endDate').value = formatDateForInput(nextWeek);
    }

    // 날짜 포맷 함수
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // 배너 데이터 로드 함수 (수정 모드)
    async function loadBannerData(id) {
        try {
            const response = await fetch(`${API_BASE_URL}/banners/${id}`);
            if (!response.ok) {
                throw new Error('배너 정보를 불러오는데 실패했습니다.');
            }

            const banner = await response.json();
            console.log('로드된 배너 데이터:', banner);

            // 폼에 데이터 채우기
            document.getElementById('bannerId').value = banner.id;
            document.getElementById('title').value = banner.title || '';

            // select box 값 설정
            const groupNameSelect = document.getElementById('groupName');
            for (let i = 0; i < groupNameSelect.options.length; i++) {
                if (groupNameSelect.options[i].value === banner.groupName) {
                    groupNameSelect.selectedIndex = i;
                    break;
                }
            }

            // 링크 타겟 설정
            document.getElementById('linkTarget').value = banner.linkTarget || '';

            // 링크 타겟 타입 설정
            const linkTargetTypeSelect = document.getElementById('linkTargetType');
            for (let i = 0; i < linkTargetTypeSelect.options.length; i++) {
                if (linkTargetTypeSelect.options[i].value === banner.linkTargetType) {
                    linkTargetTypeSelect.selectedIndex = i;
                    break;
                }
            }

            // 날짜 설정
            if (banner.startDate) {
                document.getElementById('startDate').value = formatDateTime(banner.startDate);
            }
            if (banner.endDate) {
                document.getElementById('endDate').value = formatDateTime(banner.endDate);
            }

            // 상태 설정
            if (banner.status === 'active') {
                document.getElementById('statusActive').checked = true;
            } else {
                document.getElementById('statusInactive').checked = true;
            }

            // 이미지 설정
            if (banner.imageUrl) {
                document.getElementById('preview-image').src = banner.imageUrl;
                // 파일 선택 필드의 텍스트 업데이트
                const fileSpan = document.querySelector('.form__span--file');
                if (fileSpan) {
                    fileSpan.textContent = banner.imageUrl;
                }
            }
        } catch (error) {
            console.error('배너 데이터 로드 실패:', error);
            alert('배너 정보를 불러오는데 실패했습니다. 목록 페이지로 이동합니다.');
            window.location.href = 'Banner.html';
        }
    }

    // 날짜 형식 변환 함수
    function formatDateTime(dateString) {
        if (!dateString) return '';

        // ISO 형식의 날짜 문자열을 Date 객체로 변환
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // 폼 유효성 검사
    function validateForm() {
        let isValid = true;

        // 필드 검증
        const title = document.getElementById('title').value.trim();
        const fileInput = document.getElementById('upload1');
        const previewImage = document.getElementById('preview-image');
        const startDate = document.getElementById('startDate').value.trim();
        const endDate = document.getElementById('endDate').value.trim();

        // 제목 검증
        if (title === '') {
            document.getElementById('title-error').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('title-error').style.display = 'none';
        }

        // 파일 검증 (새 배너 등록 시에만 필수, 수정 시 이미 이미지가 있으면 필수 아님)
        if (!isEditing && fileInput.files.length === 0) {
            document.getElementById('file-error').style.display = 'block';
            isValid = false;
        } else if (isEditing && fileInput.files.length === 0 && !previewImage.src) {
            document.getElementById('file-error').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('file-error').style.display = 'none';
        }

        // 날짜 검증
        const dateRegex = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/;

        if (!dateRegex.test(startDate)) {
            document.getElementById('startDate-error').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('startDate-error').style.display = 'none';
        }

        if (!dateRegex.test(endDate)) {
            document.getElementById('endDate-error').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('endDate-error').style.display = 'none';
        }

        return isValid;
    }

    // 배너 저장 함수
    async function saveBanner() {
        try {
            // FormData 객체 생성
            const formData = new FormData();

            // 파일 추가 (필수 항목)
            const fileInput = document.getElementById('upload1');
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }

            // 배너 정보 설정
            if (isEditing) {
                // 수정 모드
                const bannerId = document.getElementById('bannerId').value;
                const bannerData = {
                    startDate: document.getElementById('startDate').value.trim(),
                    endDate: document.getElementById('endDate').value.trim(),
                    groupName: document.getElementById('groupName').value,
                    title: document.getElementById('title').value.trim(),
                    linkTarget: document.getElementById('linkTarget').value.trim() || "",
                    linkTargetType: document.getElementById('linkTargetType').value,
                    status: document.getElementById('statusActive').checked ? "active" : "inactive"
                };

                // JSON 데이터를 Blob으로 변환하여 FormData에 추가
                const bannerBlob = new Blob([JSON.stringify(bannerData)], { type: 'application/json' });
                formData.append('request', bannerBlob);

                // API 호출 (PUT 메서드)
                const response = await fetch(`${API_BASE_URL}/admin/banners/${bannerId}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('배너 수정 성공:', result);

                    document.getElementById('success-message').textContent = '배너가 성공적으로 수정되었습니다.';
                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('error-alert').style.display = 'none';

                    setTimeout(() => {
                        window.location.href = 'Banner.html';
                    }, 3000);
                } else {
                    const errorData = await response.text();
                    console.error('서버 응답:', errorData);
                    throw new Error('배너 수정 실패: ' + (errorData || '서버 오류'));
                }
            } else {
                // 등록 모드 - 백엔드에서 bannerId를 생성하도록 함
                const bannerData = {
                    bannerId: generateBannerId(),
                    title: document.getElementById('title').value.trim(),
                    groupName: document.getElementById('groupName').value,
                    startDate: document.getElementById('startDate').value.trim(),
                    endDate: document.getElementById('endDate').value.trim(),
                    status: document.querySelector('input[name="status"]:checked').value.toLowerCase(),
                    linkTarget: document.getElementById('linkTarget').value.trim() || "",
                    linkTargetType: document.getElementById('linkTargetType').value
                };

                // bannerId를 삭제하거나 null로 전송 (백엔드에서 생성하도록)
                // bannerId: null, // 백엔드에서 생성

                // JSON 데이터를 Blob으로 변환하여 FormData에 추가
                const bannerBlob = new Blob([JSON.stringify(bannerData)], { type: 'application/json' });
                formData.append('request', bannerBlob);

                console.log('전송할 데이터:', JSON.stringify(bannerData));

                // API 호출 (POST 메서드)
                const response = await fetch(`${API_BASE_URL}/admin/banners`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('배너 등록 성공:', result);

                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('error-alert').style.display = 'none';

                    setTimeout(() => {
                        window.location.href = 'Banner.html';
                    }, 3000);
                } else {
                    const errorData = await response.text();
                    console.error('서버 응답:', errorData);
                    throw new Error('배너 등록 실패: ' + (errorData || '서버 오류'));
                }
            }
        } catch (error) {
            console.error('오류 발생:', error);
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-alert').style.display = 'block';
            document.getElementById('error-alert').textContent = isEditing ?
                '배너 수정 중 오류가 발생했습니다: ' + error.message :
                '배너 등록 중 오류가 발생했습니다: ' + error.message;
        }
    }

    document.getElementById('btnLogout').addEventListener('click', function() {
        if (confirm('로그아웃 하시겠습니까?')) {
            // 세션 스토리지 및 로컬 스토리지 클리어
            sessionStorage.clear();
            localStorage.removeItem('token');

            // 로그인 페이지로 리다이렉트
            window.location.href = '/admin/login.html';
        }
    });

    // 배너 ID 생성 함수 (예: 'banner_' + timestamp)
    function generateBannerId() {
        return 'banner_' + Date.now();
    }
</script>
</body>
</html>